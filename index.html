<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hexaloop</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700;900&family=JetBrains+Mono:wght@400;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Fredoka+One&family=Mountains+of+Christmas:wght@700&display=swap');

        :root {
            --bg-color: #020617;
            --accent-color: #4f46e5;
            --glass-bg: rgba(10, 15, 30, 0.85); 
            --glass-border: rgba(255, 255, 255, 0.12);
            --glass-highlight: rgba(255, 255, 255, 0.05);
            --text-main: #ffffff;
            --text-muted: #94a3b8;
            --sidebar-w: 360px;
            --blob-opacity: 0.25;
            --canvas-bg: rgba(5, 10, 20, 0.6);
            --hud-bg: rgba(0,0,0,0.75);
        }

        [data-theme="light"] {
            --bg-color: #f0f9ff;
            --accent-color: #0ea5e9;
            --glass-bg: rgba(255, 255, 255, 0.85);
            --glass-border: rgba(255, 255, 255, 0.6);
            --glass-highlight: rgba(255, 255, 255, 0.4);
            --text-main: #0f172a;
            --text-muted: #475569;
            --blob-opacity: 0.15;
            --canvas-bg: rgba(255, 255, 255, 0.6);
            --hud-bg: rgba(255,255,255,0.9);
        }

        body {
            background-color: var(--bg-color);
            font-family: 'Outfit', sans-serif;
            overflow: hidden;
            touch-action: none;
            color: var(--text-main);
            transition: background-color 0.6s cubic-bezier(0.4, 0, 0.2, 1), color 0.6s;
        }

        /* --- BACKGROUND FX --- */
        .ambient-light {
            position: absolute;
            inset: 0;
            overflow: hidden;
            z-index: 0;
            pointer-events: none;
        }
        .blob {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: var(--blob-opacity);
            animation: float 25s infinite ease-in-out;
            transition: opacity 0.6s;
        }
        .blob-1 { top: -10%; left: -10%; width: 50vw; height: 50vw; background: var(--accent-color); }
        .blob-2 { bottom: -20%; right: -10%; width: 60vw; height: 60vw; background: #ec4899; animation-delay: -5s; }

        @keyframes float {
            0%, 100% { transform: translate(0, 0); }
            50% { transform: translate(20px, -20px); }
        }

        /* --- GLASS UI --- */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 20px 50px -10px rgba(0,0,0,0.4), inset 0 0 0 1px var(--glass-highlight);
            transition: background 0.6s, border-color 0.6s;
        }

        /* --- TOP RIGHT SPECIAL ACCESS --- */
        #special-access {
            position: fixed;
            top: 1.5rem;
            right: 1.5rem;
            z-index: 150;
            display: flex;
            gap: 0.75rem;
        }

        /* --- SIDEBAR --- */
        #sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100%;
            width: var(--sidebar-w);
            z-index: 100;
            transform: translateX(0);
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--glass-border);
            overflow: hidden; 
        }
        #sidebar.collapsed { transform: translateX(-100%); }

        @media (max-width: 640px) {
            :root { --sidebar-w: 100%; } 
            #sidebar { width: 100%; border-right: none; }
        }

        .sidebar-header { padding: 2rem 2rem 1rem 2rem; flex-shrink: 0; }
        
        /* Rainbow Hover for Title */
        .title-loop {
            transition: color 0.3s;
            cursor: default;
        }
        .title-loop:hover {
            animation: rainbow 1.5s linear infinite;
        }
        @keyframes rainbow {
            0% { color: #ef4444; }
            15% { color: #f97316; }
            30% { color: #eab308; }
            45% { color: #22c55e; }
            60% { color: #3b82f6; }
            75% { color: #a855f7; }
            100% { color: #ef4444; }
        }

        .sidebar-content {
            flex-grow: 1;
            overflow-y: auto;
            padding: 0 2rem;
            scrollbar-width: none; 
            position: relative;
        }
        .sidebar-content::-webkit-scrollbar { display: none; }
        
        /* Scroll Hint Indicator */
        .scroll-hint {
            position: absolute;
            bottom: 1rem;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            pointer-events: none;
            opacity: 1;
            transition: opacity 0.3s;
            color: var(--text-muted);
            font-size: 0.7rem;
            font-weight: 700;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            animation: bounce 2s infinite;
            z-index: 20;
        }
        .scroll-hint.fade-out { opacity: 0; }
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {transform: translateY(0);}
            40% {transform: translateY(-5px);}
            60% {transform: translateY(-3px);}
        }

        .sidebar-footer {
            padding: 1.5rem 2rem 2.5rem 2rem;
            flex-shrink: 0;
            background: linear-gradient(to top, var(--glass-bg) 90%, transparent);
            z-index: 10;
            border-top: 1px solid var(--glass-border);
        }

        /* Toggle Button */
        #sidebar-toggle {
            position: fixed;
            top: 1.5rem;
            left: 1.5rem;
            z-index: 110;
            width: 48px; 
            height: 48px;
            border-radius: 14px;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            color: var(--text-main);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        #sidebar-toggle:hover { transform: scale(1.05); }
        #sidebar:not(.collapsed) + #sidebar-toggle { opacity: 0; pointer-events: none; transform: translateX(-20px); }

        .icon-btn {
            padding: 0.75rem;
            cursor: pointer;
            opacity: 0.8;
            transition: all 0.2s;
            background: rgba(125, 125, 125, 0.1);
            border-radius: 10px;
            border: 1px solid transparent;
            color: var(--text-main);
        }
        .icon-btn:hover { opacity: 1; background: rgba(125, 125, 125, 0.2); }
        
        .frog-btn {
            color: #4ade80;
            border-color: rgba(74, 222, 128, 0.2);
            background: rgba(74, 222, 128, 0.1);
        }
        .frog-btn:hover {
            background: rgba(74, 222, 128, 0.2);
            box-shadow: 0 0 10px rgba(74, 222, 128, 0.3);
        }

        .xmas-btn {
            width: 48px; height: 48px;
            display: flex; align-items: center; justify-content: center;
            color: #f43f5e;
            border: 1px solid rgba(244, 63, 94, 0.5);
            background: rgba(244, 63, 94, 0.15);
            border-radius: 14px;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
            box-shadow: 0 0 20px rgba(244, 63, 94, 0.2);
            transition: all 0.3s;
        }
        .xmas-btn:hover {
            background: rgba(244, 63, 94, 0.3);
            box-shadow: 0 0 30px rgba(244, 63, 94, 0.5);
            transform: scale(1.1);
        }
        .xmas-btn::after {
            content: '';
            position: absolute;
            top: -50%; left: -50%; width: 200%; height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.8), transparent);
            transform: rotate(45deg);
            animation: shine 3s infinite;
        }
        @keyframes shine {
            0% { transform: translateX(-150%) rotate(45deg); }
            20% { transform: translateX(150%) rotate(45deg); }
            100% { transform: translateX(150%) rotate(45deg); }
        }

        .mode-btn {
            font-size: 0.75rem;
            font-weight: 800;
            padding: 1rem;
            letter-spacing: 0.05em;
            border: 1px solid transparent;
            border-radius: 0.75rem;
            transition: all 0.2s;
            text-align: center;
            color: var(--text-muted);
            background: rgba(125,125,125,0.03);
        }
        .mode-btn:hover { color: var(--text-main); background: rgba(125,125,125,0.1); }
        .mode-btn.active-mode {
            background: rgba(125,125,125,0.15);
            border-color: var(--glass-border);
            color: var(--text-main);
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        /* --- CANVAS --- */
        #game-wrapper {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            transition: margin-left 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
        @media (min-width: 768px) {
            body:has(#sidebar:not(.collapsed)) #game-wrapper { margin-left: calc(var(--sidebar-w) / 2); }
        }

        canvas {
            border-radius: 1.5rem;
            background: var(--canvas-bg); 
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 30px 60px -15px rgba(0, 0, 0, 0.4);
            transition: background 0.6s;
            max-width: 100%;
            max-height: 100%;
        }

        /* --- SLIDERS --- */
        .slider-wrapper {
            position: relative;
            width: 100%;
            display: flex;
            align-items: center;
        }
        
        .scroll-row {
            display: flex;
            overflow-x: auto;
            gap: 0.75rem;
            padding: 0.5rem;
            scroll-snap-type: x mandatory;
            scrollbar-width: none;
            -ms-overflow-style: none;
            scroll-behavior: smooth;
            width: 100%;
        }
        .scroll-row::-webkit-scrollbar { display: none; }

        .scroll-item {
            flex: 0 0 auto;
            width: 72px;
            height: 72px;
            border-radius: 1rem;
            background: rgba(125,125,125,0.05);
            border: 1px solid var(--glass-border);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            scroll-snap-align: center;
            position: relative;
        }
        .scroll-item:hover { 
            background: rgba(125,125,125,0.1); 
            transform: translateY(-2px) scale(1.05); 
        }
        .scroll-item.selected {
            background: rgba(125,125,125,0.2);
            border-color: var(--text-main);
            box-shadow: 0 0 0 2px var(--glass-bg), 0 0 0 4px var(--text-main);
            z-index: 2;
        }

        .slider-nav-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-main);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s, transform 0.2s;
            pointer-events: none;
        }
        .slider-wrapper:hover .slider-nav-btn { opacity: 1; pointer-events: auto; }
        .slider-nav-btn:hover { background: var(--text-main); color: var(--bg-color); transform: translateY(-50%) scale(1.1); }
        
        .nav-left { left: -10px; }
        .nav-right { right: -10px; }

        .dot { width: 24px; height: 24px; border-radius: 50%; transition: transform 0.3s; }
        .scroll-item:hover .dot { transform: scale(1.2); }

        .action-btn {
            width: 100%;
            padding: 1.2rem;
            border-radius: 1rem;
            background: var(--text-main);
            color: var(--bg-color);
            font-weight: 800;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            border: none;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
            overflow: hidden;
        }
        .action-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); opacity: 0.9; }
        .action-btn:active { transform: translateY(0); }

        /* --- DIFFICULTY PANEL --- */
        #difficulty-panel {
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: rgba(125,125,125,0.05);
            border: 1px solid var(--glass-border);
            border-radius: 1rem;
            display: none;
        }
        #difficulty-panel.active { display: block; }
        
        .diff-slider-container {
            position: relative;
            height: 6px;
            background: rgba(125,125,125,0.2);
            border-radius: 3px;
            margin: 1.5rem 0.5rem;
        }
        .diff-slider-fill {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            background: var(--accent-color);
            border-radius: 3px;
            width: 50%;
        }
        input[type=range] {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            opacity: 0;
            cursor: pointer;
            z-index: 2;
        }
        .diff-thumb {
            position: absolute;
            top: 50%;
            width: 20px; /* Larger thumb */
            height: 20px;
            background: var(--text-main);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
            pointer-events: none;
            z-index: 1;
            left: 50%;
        }
        .diff-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.7rem;
            font-weight: 700;
            color: var(--text-muted);
            margin-top: 0.75rem;
            text-transform: uppercase;
        }

        /* --- HUD --- */
        .hud {
            position: absolute;
            bottom: 2.5rem;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 1rem;
            pointer-events: none;
            transition: bottom 0.3s;
            z-index: 20;
        }
        body.coaching-active .hud {
            bottom: 12rem; 
        }

        .hud-pill {
            background: var(--hud-bg);
            backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            padding: 0.75rem 1.5rem;
            border-radius: 99px;
            font-weight: 700;
            font-size: 0.875rem;
            letter-spacing: 0.05em;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            white-space: nowrap;
            color: white; 
        }
        [data-theme="light"] .hud-pill {
            color: #0f172a;
            border-color: rgba(15, 23, 42, 0.1);
        }

        /* --- COACH PANEL --- */
        #coach-panel {
            position: absolute;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            width: 90%;
            max-width: 600px;
            padding: 1.5rem;
            border-radius: 1.5rem;
            display: flex;
            align-items: flex-start;
            gap: 1.5rem;
            opacity: 0;
            pointer-events: none;
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            z-index: 50;
        }
        #coach-panel.active {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
            pointer-events: auto;
        }
        .coach-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ffd700, #f59e0b);
            box-shadow: 0 0 20px rgba(245, 158, 11, 0.3);
            flex-shrink: 0;
            border: 2px solid rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }
        .coach-content { flex-grow: 1; }
        .coach-content h3 {
            font-size: 0.75rem;
            font-weight: 800;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            color: #f59e0b;
            margin-bottom: 0.25rem;
        }
        .coach-content p {
            font-size: 0.95rem;
            line-height: 1.5;
            color: var(--text-main);
        }
        
        /* Floating Skip Button */
        #skipBtnContainer {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 200;
            pointer-events: auto;
        }
        .skip-btn {
            padding: 1rem 1.5rem;
            border-radius: 99px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(12px);
            color: var(--text-main);
            border: 1px solid var(--glass-border);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            font-weight: 800;
            font-size: 0.8rem;
            letter-spacing: 0.05em;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .skip-btn:hover { 
            background: var(--text-main); 
            color: var(--bg-color);
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }
        .skip-btn.hidden {
            opacity: 0;
            pointer-events: none;
            transform: translateY(20px);
        }

        /* --- MODE INTRO OVERLAY --- */
        #mode-intro {
            position: fixed;
            inset: 0;
            z-index: 300;
            display: flex;
            flex-direction: column; 
            align-items: center;
            justify-content: center;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.5s;
            background: #000;
        }
        #mode-intro.active { opacity: 1; pointer-events: auto; }
        
        .intro-title {
            font-family: 'Fredoka One', cursive;
            font-size: 6rem;
            text-align: center;
            line-height: 1;
            transform: scale(0.5);
            opacity: 0;
            transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .intro-subtitle {
            font-family: 'Outfit', sans-serif;
            font-size: 1.5rem;
            margin-top: 1rem;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) 0.3s;
            font-weight: 700;
            letter-spacing: 0.05em;
        }
        
        #mode-intro.active .intro-title { transform: scale(1); opacity: 1; }
        #mode-intro.active .intro-subtitle { transform: translateY(0); opacity: 1; }

        /* Special Themes for Intro */
        .frog-theme-intro { background: #022c22 !important; }
        .frog-theme-intro .intro-title { color: #4ade80; text-shadow: 0 10px 0 #166534; }
        .frog-theme-intro .intro-subtitle { color: #86efac; }

        .xmas-theme-intro { background: #7f1d1d !important; }
        .xmas-theme-intro .intro-title { font-family: 'Mountains of Christmas', serif; color: #fff; text-shadow: 0 0 20px #ef4444; }
        .xmas-theme-intro .intro-subtitle { color: #fca5a5; }

        /* --- MODAL --- */
        #modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(20px);
            z-index: 200;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
        #modal.active { opacity: 1; pointer-events: auto; }
        
        .modal-box {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            padding: 3rem;
            border-radius: 2rem;
            text-center;
            transform: scale(0.95) translateY(20px);
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow: 0 25px 80px rgba(0,0,0,0.4);
            max-width: 90%;
            width: 450px;
            color: var(--text-main);
        }
        #modal.active .modal-box { transform: scale(1) translateY(0); }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 2rem;
            text-align: left;
        }
        .stat-item {
            background: rgba(125,125,125,0.05);
            border-radius: 0.75rem;
            padding: 1rem;
            border: 1px solid var(--glass-border);
        }
        .stat-label { font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.1em; font-weight: 700; display: block; margin-bottom: 0.25rem; }
        .stat-val { font-size: 1.25rem; font-family: 'JetBrains Mono', monospace; font-weight: 700; color: var(--text-main); }

        /* Flux & IQ Bars */
        .flux-wall-indicator {
            height: 4px;
            background: rgba(255,255,255,0.1);
            border-radius: 2px;
            margin-top: 1rem;
            overflow: hidden;
            width: 100%;
        }
        .flux-bar {
            height: 100%;
            background: currentColor;
            width: 0%;
            transition: width 0.3s;
        }
        .iq-progress-container {
            height: 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
            margin: 0.5rem 0 2rem 0;
            overflow: hidden;
        }
        .iq-progress-bar {
            height: 100%;
            background: #fbbf24;
            width: 0%;
            transition: width 0.5s ease;
        }

        .deluxe-glitch {
            animation: glitch 0.2s cubic-bezier(.25, .46, .45, .94) both infinite;
            color: #f43f5e;
        }
        @keyframes glitch {
            0% { transform: translate(0) }
            20% { transform: translate(-2px, 2px) }
            40% { transform: translate(-2px, -2px) }
            60% { transform: translate(2px, 2px) }
            80% { transform: translate(2px, -2px) }
            100% { transform: translate(0) }
        }
        .disclaimer {
            font-size: 0.65rem;
            color: var(--text-muted);
            margin-top: 1.5rem;
            opacity: 0.7;
            line-height: 1.4;
        }

    </style>
</head>
<body>

    <div class="ambient-light">
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>
    </div>

    <!-- Mode Intro Overlay -->
    <div id="mode-intro">
        <h1 class="intro-title" id="intro-title-text">MODE</h1>
        <p class="intro-subtitle" id="intro-sub-text">Subtitle</p>
    </div>

    <!-- Top Right Controls (Santa Edition) -->
    <div id="special-access">
        <button id="xmasBtn" class="icon-btn xmas-btn" title="Santa Limited Edition">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2L2 22h20L12 2z"/>
                <path d="M12 6l-4 8h8l-4-8z" fill="currentColor" opacity="0.3"/>
            </svg>
        </button>
    </div>

    <!-- Sidebar Menu (Fixed Layout) -->
    <aside id="sidebar" class="glass-panel collapsed">
        
        <!-- Header -->
        <div class="sidebar-header">
            <div class="flex justify-between items-center">
                <h1 class="text-3xl font-black tracking-tighter title-loop" style="color: var(--text-main);">HEXA<span class="text-indigo-500">LOOP</span></h1>
                <div class="flex gap-2">
                    <!-- Frog Mode Button (Kept in Menu) -->
                    <button id="frogBtn" class="icon-btn frog-btn" title="Frog Mode">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/>
                            <circle cx="9" cy="10" r="1.5"/>
                            <circle cx="15" cy="10" r="1.5"/>
                            <path d="M8 15s1.5 2 4 2 4-2 4-2"/>
                        </svg>
                    </button>
                    <!-- Theme Toggle -->
                    <button id="themeBtn" class="icon-btn" title="Toggle Day/Night">
                        <svg id="moonIcon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="hidden">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                        </svg>
                        <svg id="sunIcon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="5"></circle>
                            <line x1="12" y1="1" x2="12" y2="3"></line>
                            <line x1="12" y1="21" x2="12" y2="23"></line>
                            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                            <line x1="1" y1="12" x2="3" y2="12"></line>
                            <line x1="21" y1="12" x2="23" y2="12"></line>
                            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                        </svg>
                    </button>
                    <!-- Close -->
                    <button class="icon-btn" id="sidebar-close">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Scrollable Content -->
        <div class="sidebar-content" id="sidebarContent">
            <!-- Mode Select -->
            <p class="text-xs font-bold mb-2 uppercase tracking-widest" style="color: var(--text-muted);">Protocol</p>
            <div class="mb-8 p-1 rounded-xl grid grid-cols-2 gap-2">
                <button class="mode-btn" id="modeNormalBtn">NORMAL</button>
                <button class="mode-btn text-amber-500" id="modeIqBtn">IQ TEST</button>
                <button class="mode-btn text-rose-500" id="modeFluxBtn">FLUX</button>
                <button class="mode-btn text-purple-500" id="modeDeluxeBtn">DELUXE</button>
                <button class="mode-btn col-span-2 text-yellow-400 border-yellow-500/30 bg-yellow-500/10" id="modeCoachBtn">ACADEMY</button>
            </div>

            <!-- Difficulty Slider (Visible only for Normal) -->
            <div id="difficulty-panel" class="active">
                <p class="text-xs font-bold uppercase tracking-widest" style="color: var(--text-muted);">Difficulty</p>
                <div class="diff-slider-container">
                    <div id="diff-fill" class="diff-slider-fill" style="width: 50%;"></div>
                    <div id="diff-thumb" class="diff-thumb" style="left: 50%;"></div>
                    <input type="range" id="diff-range" min="0" max="100" value="50">
                </div>
                <div class="diff-labels">
                    <span>Beginner</span>
                    <span id="diff-val-text" style="color: var(--accent-color);">Normal</span>
                    <span>Impossible</span>
                </div>
            </div>

            <!-- Agent Select (Slider) -->
            <div class="mb-6">
                <div class="flex justify-between items-baseline mb-3">
                    <p class="text-xs font-bold uppercase tracking-widest" style="color: var(--text-muted);">Agent</p>
                    <span id="agent-name" class="text-[10px] font-mono opacity-80" style="color: var(--text-main);">NEON</span>
                </div>
                
                <!-- Improved Slider Wrapper -->
                <div class="slider-wrapper group">
                    <button class="slider-nav-btn nav-left" onclick="scrollSlider('char-grid', -1)">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="15 18 9 12 15 6"></polyline></svg>
                    </button>
                    <div class="scroll-row" id="char-grid"></div>
                    <button class="slider-nav-btn nav-right" onclick="scrollSlider('char-grid', 1)">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="9 18 15 12 9 6"></polyline></svg>
                    </button>
                </div>
            </div>

            <!-- Theme Select (Slider) -->
            <div class="mb-8">
                <p class="text-xs font-bold uppercase tracking-widest mb-3" style="color: var(--text-muted);">Visuals</p>
                <div class="slider-wrapper group">
                    <button class="slider-nav-btn nav-left" onclick="scrollSlider('theme-grid', -1)">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="15 18 9 12 15 6"></polyline></svg>
                    </button>
                    <div class="scroll-row" id="theme-grid"></div>
                    <button class="slider-nav-btn nav-right" onclick="scrollSlider('theme-grid', 1)">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="9 18 15 12 9 6"></polyline></svg>
                    </button>
                </div>
            </div>
            
            <!-- Scroll Hint -->
            <div id="scrollHint" class="scroll-hint">
                <span>Scroll For More</span>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="ml-1"><path d="M6 9l6 6 6-6"/></svg>
            </div>
        </div>

        <!-- Fixed Footer -->
        <div class="sidebar-footer">
            <div id="mode-desc" class="mb-4 text-xs leading-relaxed border-l-2 pl-3" style="color: var(--text-muted); border-color: var(--accent-color);">
                Standard containment protocol. Unlimited walls.
            </div>
            <button id="startBtn" class="action-btn">Initialize</button>
            <p class="text-[10px] text-center mt-4 font-mono opacity-60" style="color: var(--text-muted);">
                HEXALOOP V13.0 <span class="ml-2 opacity-50">| ARTIN</span>
            </p>
        </div>
    </aside>

    <!-- Sidebar Toggle -->
    <button id="sidebar-toggle">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="3" y1="12" x2="21" y2="12"></line>
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
    </button>

    <!-- Game Area -->
    <div id="game-wrapper">
        <canvas id="gameCanvas"></canvas>
        
        <div class="hud">
            <div class="hud-pill border-indigo-500/30" style="color: var(--text-muted);">
                <span class="text-[10px] font-bold mr-2 opacity-70">MOVES</span>
                <span id="moveCount" class="text-xl" style="color: var(--text-main);">0</span>
            </div>
            <div id="statusPill" class="hud-pill text-emerald-400 border-emerald-500/30 text-sm tracking-wider">
                ACTIVE
            </div>
            <!-- Flux/Deluxe Meter -->
            <div id="fluxPill" class="hidden hud-pill text-rose-400 border-rose-500/30 flex-col items-start gap-1 py-2">
                <div class="flex justify-between w-full text-[10px] font-bold tracking-widest">
                    <span id="fluxLabel">STABILITY</span>
                    <span id="fluxVal">0/6</span>
                </div>
                <div class="flux-wall-indicator"><div id="fluxBar" class="flux-bar"></div></div>
            </div>
        </div>

        <!-- COACH PANEL -->
        <div id="coach-panel" class="glass-panel">
            <div class="coach-avatar">üéì</div>
            <div class="coach-content">
                <h3>MENTOR SYSTEM</h3>
                <p id="coach-msg">Welcome, Cadet. Let's begin your containment training.</p>
            </div>
        </div>

        <!-- Floating Skip Button (Bottom Right) -->
        <div id="skipBtnContainer">
            <button id="skipBtn" class="skip-btn hidden" title="Use your one-time skip">
                <span>Skip Lesson</span>
                <span class="text-xs opacity-70">(1 left)</span>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="9 18 15 12 9 6"></polyline></svg>
            </button>
        </div>
    </div>

    <!-- Modal -->
    <div id="modal">
        <div class="modal-box">
            <div class="flex justify-center mb-6">
                <div id="modalIconBg" class="w-24 h-24 rounded-full bg-gradient-to-br from-indigo-500/20 to-purple-500/20 flex items-center justify-center border border-white/10 shadow-lg">
                    <div id="modalIcon" class="text-5xl drop-shadow-lg">üèÜ</div>
                </div>
            </div>
            
            <h2 id="modalTitle" class="text-4xl font-black mb-2 tracking-tight" style="color: var(--text-main);">SECURED</h2>
            <p id="modalMsg" class="mb-6 text-sm font-medium" style="color: var(--text-muted);">Target contained.</p>
            
            <!-- Dynamic Stats Area -->
            <div id="modalStats" class="stats-grid hidden"></div>
            
            <!-- IQ Progress -->
            <div id="iqProgress" class="hidden">
                <div class="flex justify-between text-[10px] font-bold text-amber-400 mb-1">
                    <span>TEST PROGRESS</span>
                    <span id="iqRoundVal">1/5</span>
                </div>
                <div class="iq-progress-container">
                    <div id="iqProgressBar" class="iq-progress-bar"></div>
                </div>
            </div>
            
            <button id="restartBtn" class="action-btn">
                Next Run
            </button>
            
            <div id="modalDisclaimer" class="disclaimer hidden">
                * IQ Score is a simulated game statistic based on pathfinding efficiency and spatial reasoning speed. It is not a clinical assessment of intelligence.
            </div>
        </div>
    </div>

<script>
/**
 * HEXALOOP: ULTIMATE V13.0 "Holiday Special"
 * - Santa Mode with Snow & Particles
 * - Moved Santa Button to Top Right
 * - RGB Title
 * - Ice Walls
 */

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d', { alpha: true });
const dpr = Math.min(window.devicePixelRatio || 1, 2);

// UI Refs
const sidebar = document.getElementById('sidebar');
const sidebarContent = document.getElementById('sidebarContent');
const scrollHint = document.getElementById('scrollHint');
const themeBtn = document.getElementById('themeBtn');
const frogBtn = document.getElementById('frogBtn');
const xmasBtn = document.getElementById('xmasBtn');
const moonIcon = document.getElementById('moonIcon');
const sunIcon = document.getElementById('sunIcon');
const charGrid = document.getElementById('char-grid');
const themeGrid = document.getElementById('theme-grid');
const moveEl = document.getElementById('moveCount');
const statusPill = document.getElementById('statusPill');
const fluxPill = document.getElementById('fluxPill');
const fluxBar = document.getElementById('fluxBar');
const fluxVal = document.getElementById('fluxVal');
const fluxLabel = document.getElementById('fluxLabel');
const agentNameEl = document.getElementById('agent-name');
const modeDesc = document.getElementById('mode-desc');
const coachPanel = document.getElementById('coach-panel');
const coachMsg = document.getElementById('coach-msg');
const skipBtn = document.getElementById('skipBtn');
const diffPanel = document.getElementById('difficulty-panel');
const diffRange = document.getElementById('diff-range');
const diffFill = document.getElementById('diff-fill');
const diffThumb = document.getElementById('diff-thumb');
const diffText = document.getElementById('diff-val-text');
const modeIntro = document.getElementById('mode-intro');
const introTitle = document.getElementById('intro-title-text');
const introSub = document.getElementById('intro-sub-text');

// Modal Refs
const modal = document.getElementById('modal');
const modalTitle = document.getElementById('modalTitle');
const modalMsg = document.getElementById('modalMsg');
const modalIcon = document.getElementById('modalIcon');
const modalIconBg = document.getElementById('modalIconBg');
const modalStats = document.getElementById('modalStats');
const restartBtn = document.getElementById('restartBtn');
const iqProgress = document.getElementById('iqProgress');
const iqProgressBar = document.getElementById('iqProgressBar');
const iqRoundVal = document.getElementById('iqRoundVal');
const modalDisclaimer = document.getElementById('modalDisclaimer');

// Mode Buttons
const modeBtns = {
    normal: document.getElementById('modeNormalBtn'),
    iq: document.getElementById('modeIqBtn'),
    flux: document.getElementById('modeFluxBtn'),
    deluxe: document.getElementById('modeDeluxeBtn'),
    coach: document.getElementById('modeCoachBtn')
};

// --- CONFIG DATA ---
// hidden: true ensures they don't appear in the general slider
const CHARACTERS = [
    { name: 'Santa', color: '#ef4444', type: 'santa', glow: '#fecaca', hidden: true }, // NEW
    { name: 'Frog', color: '#4ade80', type: 'frog', glow: '#86efac', hidden: true }, 
    { name: 'Neko', color: '#fb7185', type: 'cat', glow: '#fda4af' }, 
    { name: 'Neon', color: '#f43f5e', type: 'sphere', glow: '#fb7185' },
    { name: 'Runner', color: '#e2e8f0', type: 'human', glow: '#ffffff' }, 
    { name: 'Mentor', color: '#fbbf24', type: 'ring', glow: '#fcd34d', hidden: true },
    { name: 'Cyber', color: '#0ea5e9', type: 'cube', glow: '#38bdf8' },
    { name: 'Bio', color: '#22c55e', type: 'tri', glow: '#4ade80' },
    { name: 'Void', color: '#a855f7', type: 'void', glow: '#c084fc' },
    { name: 'Solar', color: '#f97316', type: 'star', glow: '#fb923c' },
    { name: 'Mono', color: '#64748b', type: 'glitch', glow: '#94a3b8' },
    { name: 'Spirit', color: '#6366f1', type: 'ghost', glow: '#818cf8' },
    { name: 'Volt', color: '#eab308', type: 'spark', glow: '#facc15' },
    { name: 'Pixel', color: '#10b981', type: 'cube', glow: '#34d399' },
    { name: 'Inferno', color: '#ef4444', type: 'spike', glow: '#f87171' },
    { name: 'Glacier', color: '#06b6d4', type: 'sphere', glow: '#22d3ee' },
    { name: 'Quantum', color: '#d946ef', type: 'ring', glow: '#e879f9' }
];

const THEMES = [
    { name: 'North Pole', bg: '#1e3a8a', wall: '#38bdf8', grid: 'rgba(224, 242, 254, 0.3)', hidden: true }, // NEW
    { name: 'Swamp', bg: '#064e3b', wall: '#10b981', grid: 'rgba(16, 185, 129, 0.2)', hidden: true }, 
    { name: 'Midnight', bg: '#020617', wall: '#3b82f6', grid: 'rgba(59, 130, 246, 0.15)' },
    { name: 'Amber', bg: '#271a0c', wall: '#f59e0b', grid: 'rgba(245, 158, 11, 0.15)' },
    { name: 'Matrix', bg: '#022c22', wall: '#10b981', grid: 'rgba(16, 185, 129, 0.15)' },
    { name: 'Vapor', bg: '#2e1065', wall: '#d946ef', grid: 'rgba(217, 70, 239, 0.15)' },
    { name: 'Graphite', bg: '#18181b', wall: '#e4e4e7', grid: 'rgba(255, 255, 255, 0.1)' },
    { name: 'Forest', bg: '#052e16', wall: '#4ade80', grid: 'rgba(74, 222, 128, 0.15)' },
    { name: 'Crimson', bg: '#450a0a', wall: '#f43f5e', grid: 'rgba(244, 63, 94, 0.15)' },
    { name: 'Royal', bg: '#17052b', wall: '#fbbf24', grid: 'rgba(251, 191, 36, 0.15)' }
];

// --- COACHING LEVELS ---
const COACH_LEVELS = [
    { title: "BASICS", msg: "The agent wants to escape. I've built most of the wall. Close the gap to contain it.", hint: "Look for the break in the wall structure. Only one tile completes the cage.", setup: (g) => { [ {q:4,r:5}, {q:4,r:6}, {q:5,r:6}, {q:6,r:5} ].forEach(p => g[p.q][p.r] = 1); } },
    { title: "THE WIDE NET", msg: "If you build too close, the agent will slip past. Try building a wall 2-3 tiles away from the agent.", hint: "Don't touch the agent directly. Click further out to form a large circle.", setup: (g) => { [ {q:3,r:3}, {q:7,r:3}, {q:3,r:7}, {q:7,r:7} ].forEach(p => g[p.q][p.r] = 1); } },
    { title: "THE WALL", msg: "Don't leave gaps. A solid line of defense is harder to penetrate than scattered blocks.", hint: "Connect existing blocks to form a continuous barrier.", setup: (g) => { [ {q:2,r:2}, {q:2,r:3}, {q:2,r:4}, {q:2,r:6}, {q:2,r:7} ].forEach(p => g[p.q][p.r] = 1); } },
    { title: "THE PINCH", msg: "Force the agent into a corner. When it has few options, close the trap.", hint: "The agent is heading to the bottom right. Seal that exit first.", setup: (g) => { [ {q:4,r:4}, {q:5,r:3}, {q:6,r:4}, {q:5,r:6} ].forEach(p => g[p.q][p.r] = 1); } },
    { title: "EDGE GUARD", msg: "The edge is dangerous. If the agent reaches the border, you lose. Prioritize blocking the edge path!", hint: "Ignore the center. Build a wall between the agent and the closest map edge.", setup: (g) => { target.q = 1; target.r = 5; } }
];

// --- GAME STATE ---
const BOARD_SIZE = 11;
let grid = [];
let target = { q: 5, r: 5, x: 0, y: 0, angle: 0 };
let animations = [];
let particles = [];
let fish = []; 
let snow = []; // Snow system
let mouse = { q: -1, r: -1 };
let view = { w: 0, h: 0, cx: 0, cy: 0 };
let hexRadius = 25;

// Game Logic Variables
let currentChar = CHARACTERS[3]; // Default Neon
let currentTheme = THEMES[2]; // Default Midnight
let currentMode = 'NORMAL'; 
let isGameOver = false;
let moves = 0;
let lastMoveTime = 0;
let isLightMode = false;
let difficulty = 50;
let inputLocked = false; 

// FLUX & DELUXE
let fluxLimit = 6; 
let playerWalls = [];

// IQ Mode
let iqRound = 1;
const IQ_MAX_ROUNDS = 5;
let iqData = { wins: 0, totalMoves: 0, optimalMovesMissed: 0, decisionTimeAccumulator: 0 };

// Coach Mode
let coachLevel = 0;
let coachLosses = 0;
let skipUsed = false;

// --- CORE ENGINE ---

function init() {
    grid = Array(BOARD_SIZE).fill().map(() => Array(BOARD_SIZE).fill(0));
    
    // Init Background Elements
    for(let i=0; i<5; i++) spawnFish();
    for(let i=0; i<50; i++) spawnSnow();

    // Force Dark Mode on Init
    toggleTheme(false);

    buildUI();
    resize();
    resetGame();
    requestAnimationFrame(loop);

    window.addEventListener('resize', resize);
    
    // Scroll Hint Logic
    sidebarContent.addEventListener('scroll', () => {
        if(sidebarContent.scrollTop > 20) {
            scrollHint.classList.add('fade-out');
        } else {
            scrollHint.classList.remove('fade-out');
        }
    });

    // Sidebar Controls
    document.getElementById('sidebar-toggle').onclick = () => sidebar.classList.remove('collapsed');
    document.getElementById('sidebar-close').onclick = () => sidebar.classList.add('collapsed');
    document.getElementById('startBtn').onclick = () => { sidebar.classList.add('collapsed'); resetGame(); };
    restartBtn.onclick = handleModalClick;
    themeBtn.onclick = () => toggleTheme(!isLightMode);
    
    // Special Modes
    frogBtn.onclick = () => { sidebar.classList.add('collapsed'); setMode('FROG'); };
    xmasBtn.onclick = () => { sidebar.classList.add('collapsed'); setMode('XMAS'); };

    // Difficulty Slider
    diffRange.addEventListener('input', (e) => {
        difficulty = parseInt(e.target.value);
        diffFill.style.width = difficulty + '%';
        diffThumb.style.left = difficulty + '%';
        
        let text = "Normal";
        if(difficulty < 25) text = "Beginner";
        else if(difficulty > 75) text = "Impossible";
        else if(difficulty > 60) text = "Hard";
        else if(difficulty < 40) text = "Easy";
        
        diffText.innerText = text;
    });

    // Coach Actions
    skipBtn.onclick = () => {
        if (!skipUsed) {
            skipUsed = true;
            skipBtn.classList.add('hidden');
            coachLevel++;
            if(coachLevel >= COACH_LEVELS.length) {
                setMode('NORMAL');
                resetGame();
            } else {
                resetGame();
            }
        }
    };

    // Mode Selection
    modeBtns.normal.onclick = () => setMode('NORMAL');
    modeBtns.iq.onclick = () => setMode('IQ');
    modeBtns.flux.onclick = () => setMode('FLUX');
    modeBtns.deluxe.onclick = () => setMode('DELUXE');
    modeBtns.coach.onclick = () => setMode('COACH');

    // Input Handling
    canvas.addEventListener('mousemove', e => {
        const r = canvas.getBoundingClientRect();
        const hit = pixelToHex(e.clientX - r.left, e.clientY - r.top);
        mouse.q = hit ? hit.q : -1;
        mouse.r = hit ? hit.r : -1;
    });
    
    canvas.addEventListener('mousedown', e => {
        if (mouse.q !== -1) handleInput(mouse.q, mouse.r);
    });

    canvas.addEventListener('touchstart', e => {
        e.preventDefault();
        const r = canvas.getBoundingClientRect();
        const t = e.touches[0];
        const hit = pixelToHex(t.clientX - r.left, t.clientY - r.top);
        if(hit) handleInput(hit.q, hit.r);
    }, {passive: false});

    setMode('NORMAL');
}

window.scrollSlider = function(id, dir) {
    const el = document.getElementById(id);
    if(el) el.scrollBy({ left: dir * 120, behavior: 'smooth' });
};

function toggleTheme(light) {
    isLightMode = light;
    if(light) {
        document.documentElement.setAttribute('data-theme', 'light');
        moonIcon.classList.remove('hidden');
        sunIcon.classList.add('hidden');
        if(currentTheme.name === 'Midnight') currentTheme = THEMES.find(t => t.name === 'Graphite');
    } else {
        document.documentElement.setAttribute('data-theme', 'dark');
        moonIcon.classList.add('hidden');
        sunIcon.classList.remove('hidden');
        if(currentTheme.name === 'Graphite') currentTheme = THEMES.find(t => t.name === 'Midnight');
    }
    buildUI(); // Rebuild to update theme selection visual state
}

function setMode(mode) {
    currentMode = mode;
    Object.values(modeBtns).forEach(b => b.classList.remove('active-mode'));
    
    diffPanel.classList.remove('active');
    statusPill.classList.remove('hidden');
    
    if (mode === 'NORMAL') {
        diffPanel.classList.add('active');
        modeBtns.normal.classList.add('active-mode');
        modeDesc.innerText = "Standard protocol. Adjust complexity via slider.";
        modeDesc.style.borderColor = "#94a3b8";
    } else if (mode === 'FROG') {
        playIntro("FROG MODE", "Inspired by Ms. Todd-Lister", "frog-theme-intro");
        currentChar = CHARACTERS.find(c => c.name === 'Frog');
        currentTheme = THEMES.find(t => t.name === 'Swamp');
        document.body.style.backgroundColor = currentTheme.bg;
        resetGame();
    } else if (mode === 'XMAS') {
        playIntro("HO HO HO", "Limited Time Edition", "xmas-theme-intro");
        currentChar = CHARACTERS.find(c => c.name === 'Santa');
        currentTheme = THEMES.find(t => t.name === 'North Pole');
        document.body.style.backgroundColor = currentTheme.bg;
        resetGame();
    } else {
        if (mode === 'IQ') {
            iqRound = 1;
            iqData = { wins: 0, totalMoves: 0, optimalMovesMissed: 0, decisionTimeAccumulator: 0 };
            modeBtns.iq.classList.add('active-mode');
            modeDesc.innerText = "5-Round Analysis. Tracks speed & logic efficiency.";
            modeDesc.style.borderColor = "#f59e0b";
        } else if (mode === 'FLUX') {
            modeBtns.flux.classList.add('active-mode');
            modeDesc.innerText = `Unstable. Walls decay over time.`;
            modeDesc.style.borderColor = "#f43f5e";
        } else if (mode === 'DELUXE') {
            modeBtns.deluxe.classList.add('active-mode');
            modeDesc.innerText = "The Singularity. One correct move per turn.";
            modeDesc.style.borderColor = "#a855f7";
        } else if (mode === 'COACH') {
            modeBtns.coach.classList.add('active-mode');
            modeDesc.innerText = "Interactive training modules.";
            modeDesc.style.borderColor = "#fbbf24";
        }
    }
}

function playIntro(title, sub, cssClass) {
    modeIntro.className = cssClass;
    introTitle.innerText = title;
    introSub.innerText = sub;
    modeIntro.classList.add('active');
    setTimeout(() => modeIntro.classList.remove('active'), 3000);
}

function calculateFluxLimit(gridState) {
    let walls = 0;
    for(let q=0; q<BOARD_SIZE; q++) {
        for(let r=0; r<BOARD_SIZE; r++) { if(gridState[q][r] === 1) walls++; }
    }
    return Math.max(4, 14 - Math.floor(walls * 0.6));
}

function spawnFish() {
    fish.push({
        x: Math.random() * canvas.width,
        y: Math.random() * canvas.height,
        vx: (Math.random() - 0.5) * 2,
        vy: (Math.random() - 0.5) * 2,
        angle: 0,
        size: 5 + Math.random() * 5
    });
}

function spawnSnow() {
    snow.push({
        x: Math.random() * canvas.width,
        y: Math.random() * canvas.height,
        vy: 1 + Math.random() * 2,
        size: 1 + Math.random() * 3
    });
}

function resetGame() {
    grid = Array(BOARD_SIZE).fill().map(() => Array(BOARD_SIZE).fill(0));
    target = { q: 5, r: 5 };
    
    isGameOver = false;
    moves = 0;
    playerWalls = []; 
    moveEl.innerText = '0';
    lastMoveTime = Date.now();
    inputLocked = false;

    fluxPill.classList.add('hidden');
    coachPanel.classList.remove('active');
    skipBtn.classList.add('hidden'); 
    iqProgress.classList.add('hidden');
    modalDisclaimer.classList.add('hidden');
    
    document.body.classList.remove('coaching-active');
    statusPill.className = "hud-pill text-emerald-400 border-emerald-500/30 text-sm tracking-wider";
    statusPill.innerText = "ACTIVE";

    // Mode Init
    if (currentMode === 'FROG') {
        statusPill.innerText = "FROG MODE";
        statusPill.className = "hud-pill text-green-400 border-green-500/30 text-sm tracking-wider";
        generateRandomMap(12);
    }
    else if (currentMode === 'XMAS') {
        statusPill.innerText = "HOLIDAY EVENT";
        statusPill.className = "hud-pill text-red-400 border-red-500/30 text-sm tracking-wider";
        generateRandomMap(12);
    }
    else if (currentMode === 'COACH') {
        statusPill.innerText = `LESSON ${coachLevel+1}`;
        statusPill.className = "hud-pill text-yellow-400 border-yellow-500/30 text-sm tracking-wider";
        coachPanel.classList.add('active');
        document.body.classList.add('coaching-active');
        
        const level = COACH_LEVELS[coachLevel];
        coachMsg.innerText = level.msg;
        level.setup(grid); 
        coachLosses = 0; 
        
        if (!skipUsed) {
            skipBtn.classList.remove('hidden');
            skipBtn.innerHTML = `<span>Skip Lesson</span><span class="text-xs opacity-70">(1 left)</span><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="9 18 15 12 9 6"></polyline></svg>`;
        }
    }
    else if (currentMode === 'IQ') {
        if (iqRound === 1 && iqData.totalMoves > 0) {
             iqData = { wins: 0, totalMoves: 0, optimalMovesMissed: 0, decisionTimeAccumulator: 0 };
        }
        statusPill.innerText = `IQ ROUND ${iqRound}/${IQ_MAX_ROUNDS}`;
        statusPill.className = "hud-pill text-amber-400 border-amber-500/30 text-sm tracking-wider";
        iqProgress.classList.remove('hidden');
        iqRoundVal.innerText = `${iqRound}/${IQ_MAX_ROUNDS}`;
        iqProgressBar.style.width = `${((iqRound-1)/IQ_MAX_ROUNDS)*100}%`;
        generateRandomMap(10 + (iqRound * 2));
    } 
    else if (currentMode === 'FLUX' || currentMode === 'DELUXE') {
        statusPill.innerText = currentMode === 'FLUX' ? "FLUX STATE" : "SINGULARITY";
        statusPill.className = currentMode === 'FLUX' 
            ? "hud-pill text-rose-400 border-rose-500/30 text-sm tracking-wider"
            : "hud-pill text-purple-400 border-purple-500/30 text-sm tracking-wider deluxe-glitch";
        
        fluxPill.classList.remove('hidden');
        generateRandomMap(currentMode === 'FLUX' ? 8 : 6);
        fluxLimit = currentMode === 'DELUXE' ? 5 : calculateFluxLimit(grid);
        updateFluxUI();
    } else {
        // Normal
        const wallCount = Math.floor(20 - (difficulty / 100 * 18));
        generateRandomMap(wallCount);
    }

    const p = hexToPixel(target.q, target.r);
    target.x = p.x;
    target.y = p.y;
    target.angle = 0;
}

function generateRandomMap(startWalls) {
    let placed = 0;
    while(placed < startWalls) {
        const q = Math.floor(Math.random()*BOARD_SIZE);
        const r = Math.floor(Math.random()*BOARD_SIZE);
        if(grid[q][r] === 0 && (q!==target.q || r!==target.r)) {
            grid[q][r] = 1;
            animations.push({q, r, t:0, type:'spawn'});
            placed++;
        }
    }
}

// --- LOGIC ---

function getNeighbors(q, r) {
    const dirs = [[1,0],[1,-1],[0,-1],[-1,0],[-1,1],[0,1]];
    let res = [];
    for (let d of dirs) {
        const nq = q + d[0];
        const nr = r + d[1];
        if (nq >= 0 && nq < BOARD_SIZE && nr >= 0 && nr < BOARD_SIZE) res.push({q:nq, r:nr});
    }
    return res;
}

function bfs(startPos, gridState) {
    let q = [{pos:startPos, path:[]}];
    let visited = new Set([`${startPos.q},${startPos.r}`]);

    while(q.length) {
        let {pos, path} = q.shift();
        if(pos.q===0 || pos.q===BOARD_SIZE-1 || pos.r===0 || pos.r===BOARD_SIZE-1) return path; 
        
        for(let n of getNeighbors(pos.q, pos.r)) {
            if(gridState[n.q][n.r]===0 && !visited.has(`${n.q},${n.r}`)) {
                visited.add(`${n.q},${n.r}`);
                q.push({pos:n, path:[...path, n]});
            }
        }
    }
    return null;
}

function analyzeMoveEfficiency(playedQ, playedR) {
    const pathBefore = bfs(target, grid);
    if (!pathBefore) return 0;

    grid[playedQ][playedR] = 1;
    const pathAfter = bfs(target, grid);
    grid[playedQ][playedR] = 0;

    let bestReduction = 0;
    for(let tile of pathBefore) {
        if (grid[tile.q][tile.r] === 0) {
            grid[tile.q][tile.r] = 1;
            const p = bfs(target, grid);
            grid[tile.q][tile.r] = 0;
            const dist = p ? p.length : 999;
            const diff = dist - pathBefore.length;
            if (diff > bestReduction) bestReduction = diff;
        }
        if (bestReduction > 50) break;
    }

    const actualDist = pathAfter ? pathAfter.length : 999;
    const actualReduction = actualDist - pathBefore.length;
    return (bestReduction - actualReduction); 
}

// --- GAMEPLAY ---

function handleInput(q, r) {
    if(isGameOver || inputLocked || grid[q][r]===1 || (q===target.q && r===target.r)) return;

    const now = Date.now();
    if (currentMode === 'IQ') {
        iqData.decisionTimeAccumulator += (now - lastMoveTime);
        const penalty = analyzeMoveEfficiency(q, r);
        iqData.optimalMovesMissed += penalty > 0 ? penalty : 0; 
    }
    lastMoveTime = now;

    if (currentMode === 'DELUXE') {
        const penalty = analyzeMoveEfficiency(q, r);
        if (penalty > 0) animations.push({q, r, t:0, type:'error'});
    }

    grid[q][r] = 1;
    animations.push({q, r, t:0, type:'pop'});
    moves++;
    moveEl.innerText = moves;

    inputLocked = true;
    setTimeout(() => { inputLocked = false; }, 200);

    if (currentMode === 'FLUX' || currentMode === 'DELUXE') {
        playerWalls.push({q, r});
        if (playerWalls.length > fluxLimit) {
            const old = playerWalls.shift();
            grid[old.q][old.r] = 0; 
            animations.push({q:old.q, r:old.r, t:0, type:'shatter'});
        }
        updateFluxUI();
    }

    const path = bfs(target, grid);
    
    if(!path) {
        endGame(true);
    } else {
        const next = path[0];
        target.q = next.q;
        target.r = next.r;
        
        const p = hexToPixel(target.q, target.r);
        // Christmas Sparkles
        if(currentMode === 'XMAS') {
             for(let i=0; i<8; i++) particles.push({
                x: target.x, y: target.y,
                vx: (Math.random()-0.5)*4, vy: (Math.random()-0.5)*4,
                life: 1, color: Math.random()>0.5 ? '#fbbf24' : (Math.random()>0.5 ? '#ef4444' : '#22c55e')
            });
        } else {
            for(let i=0; i<5; i++) particles.push({
                x: target.x, y: target.y,
                vx: (Math.random()-0.5)*3, vy: (Math.random()-0.5)*3,
                life: 1, color: currentChar.glow
            });
        }

        if(target.q===0 || target.q===BOARD_SIZE-1 || target.r===0 || target.r===BOARD_SIZE-1) {
            endGame(false);
        }
    }
}

function updateFluxUI() {
    fluxVal.innerText = `${playerWalls.length}/${fluxLimit}`;
    const pct = (playerWalls.length / fluxLimit) * 100;
    fluxBar.style.width = `${pct}%`;
    
    if (currentMode === 'DELUXE') {
        fluxLabel.innerText = "QUANTUM LIMIT";
        fluxPill.style.color = "#c084fc";
        fluxBar.style.backgroundColor = "#a855f7";
    } else {
        fluxLabel.innerText = "FLUX STABILITY";
        fluxPill.style.color = "#fda4af";
        fluxBar.style.backgroundColor = "#f43f5e";
    }
}

function endGame(won) {
    isGameOver = true;
    
    if (currentMode === 'COACH') {
        if (won) {
            coachMsg.innerText = "Excellent work. Protocol assimilated.";
            setTimeout(() => {
                showModal("LESSON COMPLETE", "Strategy Verified.", "üéì", coachLevel < 4 ? "Next Lesson" : "Graduate");
            }, 1000);
        } else {
            coachLosses++;
            if (coachLosses >= 3) {
                const level = COACH_LEVELS[coachLevel];
                coachMsg.innerText = `Advice: ${level.hint}`;
                showModal("LESSON FAILED", "Hint Available.", "üí°", "Retry");
            } else {
                coachMsg.innerText = "Failure. The agent escaped. Re-assess your strategy.";
                showModal("LESSON FAILED", "Try again.", "‚ö†Ô∏è", "Retry");
            }
        }
    }
    else if (currentMode === 'IQ') {
        if (won) iqData.wins++;
        iqData.totalMoves += moves;
        iqProgressBar.style.width = `${(iqRound/IQ_MAX_ROUNDS)*100}%`;
        
        if (iqRound < IQ_MAX_ROUNDS) {
            showModal("ROUND COMPLETE", won ? "Target Secured." : "Target Escaped.", won ? "üèÜ" : "‚ö†Ô∏è", "Next Round");
        } else {
            calculateAndShowIQ();
        }
    } else {
        const msg = won ? `Target contained in ${moves} moves.` : "Target breached firewall.";
        showModal(won ? "SECURED" : "FAILED", msg, won ? "üèÜ" : "‚ö†Ô∏è", "Play Again");
    }
}

function calculateAndShowIQ() {
    const avgMoves = iqData.totalMoves / IQ_MAX_ROUNDS;
    const avgTime = (iqData.decisionTimeAccumulator / iqData.totalMoves) / 1000;
    const winRate = iqData.wins / IQ_MAX_ROUNDS;
    
    let iq = 75 + (winRate * 60) + Math.max(0, 20 - (avgMoves - 8));
    if (avgTime < 2.5) iq += 15 * (1 - (avgTime/2.5));
    iq -= (iqData.optimalMovesMissed * 1.5);

    iq = Math.floor(Math.max(60, Math.min(168, iq)));

    const html = `
        <div class="stat-item">
            <span class="stat-label">Success Rate</span>
            <span class="stat-val text-emerald-400">${(winRate*100).toFixed(0)}%</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Avg. Speed</span>
            <span class="stat-val text-indigo-400">${avgTime.toFixed(2)}s</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Inefficiency</span>
            <span class="stat-val text-rose-400">${iqData.optimalMovesMissed}</span>
        </div>
        <div class="stat-item border-amber-500/30 bg-amber-500/10">
            <span class="stat-label text-amber-500">Spatial IQ</span>
            <span class="stat-val text-amber-400 text-3xl">${iq}</span>
        </div>
    `;
    
    showModal("ANALYSIS COMPLETE", "Cognitive performance evaluated.", "üß†", "Finish", html);
    modalDisclaimer.classList.remove('hidden'); 
}

function showModal(title, msg, icon, btnText, customHTML = null) {
    setTimeout(() => {
        modal.classList.add('active');
        modalTitle.innerText = title;
        modalMsg.innerText = msg;
        modalIcon.innerText = icon;
        restartBtn.innerText = btnText;
        
        if (customHTML) {
            modalStats.innerHTML = customHTML;
            modalStats.classList.remove('hidden');
        } else {
            modalStats.classList.add('hidden');
        }
        
        if (title.includes("ANALYSIS")) {
            modalTitle.style.color = "#fbbf24";
            modalIconBg.classList.add('iq-badge');
        } else {
            modalTitle.style.color = "var(--text-main)";
            modalIconBg.classList.remove('iq-badge');
            modalDisclaimer.classList.add('hidden');
        }
    }, 500);
}

function handleModalClick() {
    modal.classList.remove('active');
    
    if (currentMode === 'COACH') {
        if (modalTitle.innerText.includes("COMPLETE")) {
            if (coachLevel < 4) {
                coachLevel++;
                resetGame();
            } else {
                setMode('NORMAL');
                sidebar.classList.remove('collapsed');
            }
        } else {
            resetGame(); 
        }
    }
    else if (currentMode === 'IQ') {
        if (iqRound < IQ_MAX_ROUNDS) {
            iqRound++;
            resetGame();
        } else {
            setMode('NORMAL');
            sidebar.classList.remove('collapsed');
        }
    } else {
        resetGame();
    }
}

// --- RENDER SYSTEM ---

function buildUI() {
    // Char Slider
    charGrid.innerHTML = '';
    CHARACTERS.forEach((c, i) => {
        if(c.hidden) return; // SKIP HIDDEN CHARS
        const el = document.createElement('div');
        el.className = `scroll-item ${c === currentChar ? 'selected' : ''}`;
        el.innerHTML = `<div class="dot" style="background:${c.color};box-shadow:0 0 10px ${c.color}"></div>`;
        el.onclick = () => {
            currentChar = c;
            agentNameEl.innerText = c.name.toUpperCase();
            Array.from(charGrid.children).forEach(x=>x.classList.remove('selected'));
            el.classList.add('selected');
        };
        charGrid.appendChild(el);
    });

    // Theme Slider
    themeGrid.innerHTML = '';
    THEMES.forEach((t, i) => {
        if(t.hidden) return; // SKIP HIDDEN THEMES
        const el = document.createElement('div');
        el.className = `scroll-item ${t === currentTheme ? 'selected' : ''}`;
        el.innerHTML = `<div class="dot" style="background:${t.wall}"></div>`;
        el.onclick = () => {
            currentTheme = t;
            if(!isLightMode) document.body.style.backgroundColor = t.bg;
            Array.from(themeGrid.children).forEach(x=>x.classList.remove('selected'));
            el.classList.add('selected');
        };
        themeGrid.appendChild(el);
    });
}

function resize() {
    view.w = window.innerWidth;
    view.h = window.innerHeight;
    canvas.width = view.w * dpr;
    canvas.height = view.h * dpr;
    canvas.style.width = view.w + 'px';
    canvas.style.height = view.h + 'px';
    ctx.scale(dpr, dpr);
    view.cx = view.w/2;
    view.cy = view.h/2;
    
    const boardW = BOARD_SIZE * 1.8;
    const boardH = BOARD_SIZE * 1.6;
    const scale = Math.min(view.w/boardW, view.h/boardH) * 0.85;
    hexRadius = Math.max(18, Math.min(35, scale));
}

function hexToPixel(q, r) {
    const size = hexRadius;
    const x = view.cx + size * Math.sqrt(3) * (q + r/2) - (size * Math.sqrt(3) * BOARD_SIZE * 0.75);
    const y = view.cy + size * 1.5 * r - (size * 1.5 * BOARD_SIZE * 0.5);
    return { x: x + (size*Math.sqrt(3)*BOARD_SIZE*0.05), y };
}

function pixelToHex(x, y) {
    let min = Infinity, best = null;
    for(let q=0; q<BOARD_SIZE; q++) {
        for(let r=0; r<BOARD_SIZE; r++) {
            const p = hexToPixel(q, r);
            const d = Math.hypot(x-p.x, y-p.y);
            if(d < hexRadius && d < min) { min = d; best = {q,r}; }
        }
    }
    return best;
}

// --- RENDER LOOP ---

function drawHexPath(x, y, r) {
    ctx.beginPath();
    for(let i=0; i<6; i++) {
        const a = Math.PI/3 * (i+0.5);
        ctx[i===0?'moveTo':'lineTo'](x + r*Math.cos(a), y + r*Math.sin(a));
    }
    ctx.closePath();
}

function drawLilyPad(x, y, r) {
    ctx.beginPath();
    ctx.arc(x, y, r, 0.1 * Math.PI, 1.9 * Math.PI); 
    ctx.lineTo(x, y);
    ctx.closePath();
}

function drawGrid() {
    for(let q=0; q<BOARD_SIZE; q++) {
        for(let r=0; r<BOARD_SIZE; r++) {
            const p = hexToPixel(q, r);
            const isWall = grid[q][r]===1;
            const isHover = !isWall && !isGameOver && q===mouse.q && r===mouse.r && (q!==target.q || r!==target.r);
            const isSwamp = currentTheme.name === 'Swamp';
            const isXmas = currentTheme.name === 'North Pole';
            
            // Shape Selection
            if (isSwamp) {
                drawLilyPad(p.x, p.y, hexRadius-2);
            } else {
                drawHexPath(p.x, p.y, hexRadius-2);
            }
            
            if (isWall) {
                const isDecaying = (currentMode === 'FLUX' || currentMode === 'DELUXE') && playerWalls.length > 0 && playerWalls[0].q === q && playerWalls[0].r === r;
                
                if (isXmas) {
                    // ICE WALL
                    ctx.fillStyle = 'rgba(186, 230, 253, 0.6)'; // Ice Blue
                    ctx.fill();
                    ctx.fillStyle = 'rgba(255,255,255,0.3)'; // Highlight
                    ctx.beginPath(); ctx.arc(p.x-5, p.y-5, 5, 0, Math.PI*2); ctx.fill();
                    ctx.strokeStyle = 'rgba(255,255,255,0.6)'; ctx.lineWidth=1; ctx.stroke();
                } else {
                    const g = ctx.createLinearGradient(p.x-hexRadius, p.y-hexRadius, p.x+hexRadius, p.y+hexRadius);
                    if (isDecaying) {
                        const time = Date.now() * 0.01;
                        const rCol = Math.sin(time) > 0 ? '#fff' : '#22d3ee';
                        g.addColorStop(0, rCol);
                        g.addColorStop(1, '#000');
                    } else {
                        g.addColorStop(0, currentTheme.wall);
                        g.addColorStop(1, isLightMode ? '#cbd5e1' : '#000');
                    }
                    ctx.fillStyle = g; ctx.fill();
                    ctx.strokeStyle = isLightMode ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.2)';
                    ctx.lineWidth = 1; ctx.stroke();
                    ctx.fillStyle = isLightMode ? 'rgba(255,255,255,0.4)' : 'rgba(255,255,255,0.15)';
                    ctx.fill();
                }
            } else {
                if (isLightMode) {
                    ctx.fillStyle = isHover ? 'rgba(15, 23, 42, 0.1)' : 'rgba(255, 255, 255, 0.8)';
                    ctx.fill();
                    ctx.strokeStyle = isHover ? 'transparent' : 'rgba(15, 23, 42, 0.15)';
                    ctx.lineWidth = 1.5; ctx.stroke();
                } else {
                    ctx.fillStyle = isHover ? 'rgba(255,255,255,0.15)' : currentTheme.grid;
                    ctx.fill();
                    ctx.strokeStyle = isHover ? 'transparent' : 'rgba(255,255,255,0.05)';
                    ctx.lineWidth = 1; ctx.stroke();
                }
            }
        }
    }
    
    // Watermark
    ctx.save();
    ctx.fillStyle = isLightMode ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.05)';
    ctx.font = '10px JetBrains Mono';
    ctx.textAlign = 'right';
    ctx.fillText("MADE BY ARTIN", canvas.width/dpr - 20, canvas.height/dpr - 20);
    ctx.restore();
}

function drawAgent() {
    const c = currentChar;
    const r = hexRadius;
    const dest = hexToPixel(target.q, target.r);
    const dx = dest.x - target.x;
    const dy = dest.y - target.y;
    const dist = Math.hypot(dx, dy);
    
    target.x += dx * 0.15;
    target.y += dy * 0.15;
    target.angle += 0.02; 

    let jumpY = 0;
    if ((c.type === 'cat' || c.type === 'frog' || c.type === 'santa') && dist > 1.0) {
        jumpY = -Math.abs(Math.sin(Date.now() * 0.02)) * Math.min(dist, 20);
    }

    const g = ctx.createRadialGradient(target.x, target.y, r*0.5, target.x, target.y, r*2);
    g.addColorStop(0, c.glow+'66'); g.addColorStop(1, '#0000');
    ctx.fillStyle = g; 
    ctx.beginPath(); ctx.arc(target.x, target.y, r*2, 0, Math.PI*2); ctx.fill();

    ctx.save(); 
    ctx.translate(target.x, target.y + jumpY);
    
    // DRAWING TYPES
    if (c.type === 'santa') {
        // SANTA SKIN
        ctx.rotate(-target.angle);
        const size = r * 0.8;
        
        // Sack
        ctx.fillStyle = '#b45309';
        ctx.beginPath(); ctx.arc(size*0.8 + (dx*0.1), size*0.2, size*0.5, 0, Math.PI*2); ctx.fill();

        // Body
        ctx.fillStyle = '#ef4444';
        ctx.beginPath(); ctx.arc(0, size*0.2, size*0.7, 0, Math.PI*2); ctx.fill();
        // White buttons
        ctx.fillStyle = '#fff';
        ctx.beginPath(); ctx.arc(0, 0, 2, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(0, size*0.3, 2, 0, Math.PI*2); ctx.fill();
        
        // Beard
        ctx.fillStyle = '#f8fafc';
        ctx.beginPath(); 
        ctx.moveTo(-size*0.5, -size*0.2);
        ctx.bezierCurveTo(-size*0.5, size*0.8, size*0.5, size*0.8, size*0.5, -size*0.2);
        ctx.fill();
        
        // Face
        ctx.fillStyle = '#fca5a5';
        ctx.beginPath(); ctx.arc(0, -size*0.3, size*0.35, 0, Math.PI*2); ctx.fill();
        
        // Eyes
        ctx.fillStyle = '#000';
        ctx.beginPath(); ctx.arc(-4, -size*0.35, 1.5, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(4, -size*0.35, 1.5, 0, Math.PI*2); ctx.fill();
        
        // Hat
        ctx.fillStyle = '#ef4444';
        ctx.beginPath();
        ctx.moveTo(-size*0.5, -size*0.5);
        ctx.quadraticCurveTo(0, -size*1.5, size*0.6, -size*0.5);
        ctx.fill();
        // Brim
        ctx.fillStyle = '#fff';
        ctx.beginPath(); ctx.ellipse(0, -size*0.55, size*0.5, size*0.15, 0, 0, Math.PI*2); ctx.fill();
        
        // Bobble (Physics)
        const bobbleX = Math.sin(Date.now()*0.005) * 5 - (dx*0.2);
        ctx.beginPath(); ctx.arc(bobbleX, -size*1.2, size*0.15, 0, Math.PI*2); ctx.fill();

    } else if (c.type === 'frog') {
        const size = r * 0.7;
        ctx.fillStyle = c.color;
        ctx.beginPath(); ctx.ellipse(-size, size*0.5, size*0.4, size*0.2, -0.5, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.ellipse(size, size*0.5, size*0.4, size*0.2, 0.5, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(0, 0, size, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = isLightMode ? '#fff' : '#000';
        ctx.beginPath(); ctx.arc(-size*0.4, -size*0.6, size*0.4, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(size*0.4, -size*0.6, size*0.4, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = isLightMode ? '#000' : '#fff';
        ctx.beginPath(); ctx.arc(-size*0.4, -size*0.6, size*0.15, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(size*0.4, -size*0.6, size*0.15, 0, Math.PI*2); ctx.fill();

    } else if (c.type === 'cat') {
        ctx.rotate(-target.angle);
        const isMoving = dist > 1.0;
        const time = Date.now() * 0.015;
        const limbOffset = isMoving ? Math.sin(time * 1.5) * 4 : 0;
        const bodySize = r * 0.6;
        ctx.strokeStyle = c.color; ctx.lineWidth = 4; ctx.lineCap = 'round';
        ctx.beginPath(); ctx.moveTo(-bodySize*0.8, 0); ctx.quadraticCurveTo(-bodySize*1.5, -bodySize + Math.sin(time)*10, -bodySize*1.2 + Math.cos(time)*5, -bodySize*0.8); ctx.stroke();
        ctx.fillStyle = c.color; ctx.beginPath(); ctx.ellipse(0, 5, bodySize*1.1, bodySize*0.8, 0, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(-bodySize*0.5, bodySize*0.6 + limbOffset, 4, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(bodySize*0.5, bodySize*0.6 - limbOffset, 4, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(-bodySize*0.3, bodySize*0.7 - limbOffset, 4, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(bodySize*0.3, bodySize*0.7 + limbOffset, 4, 0, Math.PI*2); ctx.fill();
        const headBob = isMoving ? Math.abs(Math.sin(time*2))*2 : 0;
        const headY = -bodySize*0.6 + headBob;
        ctx.beginPath(); ctx.moveTo(-10, headY-10); ctx.lineTo(-15, headY-20); ctx.lineTo(-5, headY-15); ctx.fill();
        ctx.beginPath(); ctx.moveTo(10, headY-10); ctx.lineTo(15, headY-20); ctx.lineTo(5, headY-15); ctx.fill();
        ctx.beginPath(); ctx.arc(0, headY, bodySize*0.7, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = isLightMode ? '#0f172a' : '#fff'; 
        ctx.beginPath(); ctx.arc(-5, headY-2, 3, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(5, headY-2, 3, 0, Math.PI*2); ctx.fill();
        ctx.strokeStyle = isLightMode ? '#0f172a' : '#fff'; ctx.lineWidth = 1;
        ctx.beginPath(); ctx.moveTo(-2, headY+2); ctx.lineTo(-12, headY+2); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(2, headY+2); ctx.lineTo(12, headY+2); ctx.stroke();

    } else {
        ctx.rotate(target.angle);
        ctx.fillStyle = isLightMode ? '#0f172a' : '#fff'; 
        ctx.strokeStyle = c.color; 
        ctx.lineWidth = 3;

        if (c.type === 'human') {
            ctx.rotate(-target.angle); 
            const isMoving = dist > 1.0;
            const time = Date.now() * 0.015;
            const limbOffset = isMoving ? Math.sin(time) * 6 : 0;
            ctx.fillStyle = c.color;
            ctx.beginPath(); ctx.arc(-8, 0 + limbOffset, 3, 0, Math.PI*2); ctx.fill(); 
            ctx.beginPath(); ctx.arc(8, 0 - limbOffset, 3, 0, Math.PI*2); ctx.fill(); 
            ctx.fillStyle = isLightMode ? '#0f172a' : '#fff';
            ctx.beginPath(); ctx.arc(0, 0, r*0.35, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = c.color;
            ctx.beginPath(); ctx.arc(r*0.25, 0, 3, 0, Math.PI*2); ctx.fill();
        } 
        else if(c.type==='cube') { 
            ctx.strokeRect(-r/2, -r/2, r, r); ctx.fillRect(-r/3, -r/3, r*0.6, r*0.6); 
        }
        else if(c.type==='tri') {
            ctx.beginPath(); ctx.moveTo(0,-r/1.5); ctx.lineTo(r/1.5, r/1.5); ctx.lineTo(-r/1.5, r/1.5); ctx.closePath();
            ctx.fill(); ctx.stroke();
        }
        else if(c.type==='ring') {
            ctx.beginPath(); ctx.arc(0,0,r/2,0,Math.PI*2); ctx.stroke();
            ctx.beginPath(); ctx.arc(0,0,r/3,0,Math.PI*2); ctx.fill();
        }
        else { // Sphere default
            ctx.beginPath(); ctx.arc(0,0,r/2,0,Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.arc(0,0,r/1.5,0,Math.PI*1.5); ctx.stroke();
        }
    }
    ctx.restore();
}

function drawFish() {
    if (currentTheme.name !== 'Swamp') return;
    for (let f of fish) {
        f.x += f.vx; f.y += f.vy;
        if (f.x < 0) f.x = canvas.width; if (f.x > canvas.width) f.x = 0;
        if (f.y < 0) f.y = canvas.height; if (f.y > canvas.height) f.y = 0;
        ctx.save();
        ctx.translate(f.x, f.y);
        ctx.rotate(Math.atan2(f.vy, f.vx));
        ctx.fillStyle = 'rgba(16, 185, 129, 0.2)'; 
        ctx.beginPath(); ctx.ellipse(0, 0, f.size, f.size*0.4, 0, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.moveTo(-f.size, 0); ctx.lineTo(-f.size*1.5, -f.size*0.5); ctx.lineTo(-f.size*1.5, f.size*0.5); ctx.fill();
        ctx.restore();
    }
}

function drawSnow() {
    if (currentTheme.name !== 'North Pole') return;
    for (let s of snow) {
        // Wind effect
        const wind = Math.sin(Date.now() * 0.001) * 0.5;
        s.x += wind;
        s.y += s.vy;
        
        // Wrap
        if (s.y > canvas.height) s.y = 0;
        if (s.x > canvas.width) s.x = 0;
        if (s.x < 0) s.x = canvas.width;
        
        ctx.fillStyle = `rgba(255,255,255,${s.opacity})`;
        ctx.beginPath(); ctx.arc(s.x, s.y, s.size, 0, Math.PI*2); ctx.fill();
    }
}

function drawParticles() {
    for(let i=particles.length-1; i>=0; i--) {
        let p = particles[i]; 
        p.x+=p.vx; p.y+=p.vy; 
        p.life-=0.05;
        if(p.life<=0) { particles.splice(i,1); continue; }
        
        ctx.globalAlpha = p.life; 
        ctx.fillStyle = p.color;
        ctx.beginPath(); ctx.arc(p.x, p.y, 4*p.life, 0, Math.PI*2); ctx.fill();
        ctx.globalAlpha = 1;
    }
}

function drawAnimations() {
    for(let i=animations.length-1; i>=0; i--) {
        let a = animations[i]; a.t += 0.15;
        const p = hexToPixel(a.q, a.r);
        
        if (a.type === 'pop' || a.type === 'spawn') {
            if(a.t < 3) {
                const s = 1 + Math.sin(a.t*3)*0.3 * Math.exp(-a.t);
                ctx.strokeStyle = isLightMode ? '#0f172a' : '#fff'; ctx.lineWidth = 2;
                drawHexPath(p.x, p.y, (hexRadius-2)*s);
                ctx.stroke();
            } else animations.splice(i,1);
        } 
        else if (a.type === 'shatter') {
            if(a.t < 2) {
                ctx.fillStyle = `rgba(244, 63, 94, ${1 - a.t/2})`;
                ctx.beginPath();
                ctx.arc(p.x, p.y, (hexRadius-2) * (1 - a.t*0.2), 0, Math.PI*2);
                ctx.fill();
            } else animations.splice(i,1);
        }
        else if (a.type === 'error') {
            if(a.t < 3) {
                ctx.strokeStyle = `rgba(244, 63, 94, ${1 - a.t/3})`;
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.arc(p.x, p.y, hexRadius * (1 + a.t*0.5), 0, Math.PI*2);
                ctx.stroke();
            } else animations.splice(i,1);
        }
    }
}

function loop() {
    requestAnimationFrame(loop);
    ctx.clearRect(0,0, canvas.width, canvas.height);
    
    drawFish(); 
    drawSnow(); 
    drawGrid();
    drawAnimations();
    drawParticles();
    drawAgent();
}

init();

</script>
</body>
</html>
